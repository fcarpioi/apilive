<!DOCTYPE html>
<html>
<head>
    <title>FCM Token Generator</title>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-messaging-compat.js"></script>
</head>
<body>
    <h1>ğŸ”¥ Firebase FCM Token Generator</h1>
    <h2>Proyecto: live-copernico</h2>
    
    <button id="getToken" onclick="getToken()">ğŸ“± Obtener Token FCM</button>
    <button id="testNotification" onclick="testNotification()" disabled>ğŸ”” Probar NotificaciÃ³n</button>
    
    <div id="result"></div>
    <div id="tokenDisplay"></div>

    <script>
        // ğŸ”§ ConfiguraciÃ³n Firebase para live-copernico
        const firebaseConfig = {
            apiKey: "AIzaSyAeh1ZcY0i05YH9nQQgYmbABcNAmwWx0eA",
            authDomain: "live-copernico.firebaseapp.com",
            projectId: "live-copernico",
            storageBucket: "live-copernico.firebasestorage.app",
            messagingSenderId: "62103923048",
            appId: "1:62103923048:android:3416344fab2afc15720edd"
        };

        // ğŸš€ Inicializar Firebase
        firebase.initializeApp(firebaseConfig);
        const messaging = firebase.messaging();

        let currentToken = null;

        // ğŸ“± FunciÃ³n para obtener token FCM
        async function getToken() {
            try {
                document.getElementById('result').innerHTML = 'ğŸ” Obteniendo token FCM...';
                
                // ğŸ”‘ Solicitar permisos de notificaciÃ³n
                const permission = await Notification.requestPermission();
                
                if (permission === 'granted') {
                    console.log('âœ… Permisos de notificaciÃ³n concedidos');
                    
                    // ğŸ¯ Obtener token FCM (sin VAPID key por ahora)
                    const token = await messaging.getToken();
                    
                    if (token) {
                        currentToken = token;
                        console.log('ğŸ”‘ Token FCM obtenido:', token);
                        
                        document.getElementById('result').innerHTML = `
                            <h3>âœ… Token FCM Obtenido:</h3>
                            <textarea style="width:100%; height:100px;">${token}</textarea>
                            <br><br>
                            <strong>ğŸ“‹ Para copiar:</strong><br>
                            <code>${token}</code>
                        `;
                        
                        document.getElementById('testNotification').disabled = false;
                        
                    } else {
                        document.getElementById('result').innerHTML = 'âŒ No se pudo obtener el token FCM';
                    }
                    
                } else {
                    document.getElementById('result').innerHTML = 'âŒ Permisos de notificaciÃ³n denegados';
                }
                
            } catch (error) {
                console.error('âŒ Error obteniendo token:', error);
                document.getElementById('result').innerHTML = `âŒ Error: ${error.message}`;
            }
        }

        // ğŸ”” FunciÃ³n para probar notificaciÃ³n
        async function testNotification() {
            if (!currentToken) {
                alert('âŒ Primero obtÃ©n el token FCM');
                return;
            }
            
            try {
                document.getElementById('result').innerHTML += '<br><br>ğŸ”” Enviando notificaciÃ³n de prueba...';
                
                // ğŸš€ Enviar notificaciÃ³n usando tu API
                const response = await fetch('https://liveapigateway-3rt3xwiooa-uc.a.run.app/api/fcm/register-token', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        userId: 'cda49470-f919-41de-9e76-550fc1322b9f',
                        raceId: '52ec7d4a-40c1-4f74-bfa0-cf4cc76edd49',
                        fcmToken: currentToken,
                        deviceInfo: {
                            platform: 'web',
                            deviceId: 'WEB_TEST_DEVICE',
                            appVersion: '1.0.0'
                        }
                    })
                });
                
                const result = await response.json();
                console.log('ğŸ“‹ Registro resultado:', result);
                
                if (result.success) {
                    document.getElementById('result').innerHTML += '<br>âœ… Token registrado exitosamente!';
                    
                    // ğŸ”” Enviar notificaciÃ³n de prueba
                    const notifResponse = await fetch('https://liveapigateway-3rt3xwiooa-uc.a.run.app/api/fcm/push-notification', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            userId: 'cda49470-f919-41de-9e76-550fc1322b9f',
                            raceId: '52ec7d4a-40c1-4f74-bfa0-cf4cc76edd49',
                            title: 'ğŸ‰ Token Web VÃ¡lido!',
                            body: 'NotificaciÃ³n enviada con token generado desde web',
                            data: {
                                notificationType: 'web_token_test',
                                timestamp: new Date().toISOString()
                            }
                        })
                    });
                    
                    const notifResult = await notifResponse.json();
                    console.log('ğŸ”” NotificaciÃ³n resultado:', notifResult);
                    
                    document.getElementById('result').innerHTML += `<br><br>ğŸ“Š Resultado notificaciÃ³n: ${JSON.stringify(notifResult, null, 2)}`;
                    
                } else {
                    document.getElementById('result').innerHTML += `<br>âŒ Error registrando token: ${result.message}`;
                }
                
            } catch (error) {
                console.error('âŒ Error:', error);
                document.getElementById('result').innerHTML += `<br>âŒ Error: ${error.message}`;
            }
        }

        // ğŸ”” Escuchar mensajes en primer plano
        messaging.onMessage((payload) => {
            console.log('ğŸ”” Mensaje recibido en primer plano:', payload);
            
            document.getElementById('result').innerHTML += `
                <br><br>ğŸ‰ <strong>Â¡NOTIFICACIÃ“N RECIBIDA!</strong>
                <br>ğŸ“‹ TÃ­tulo: ${payload.notification?.title}
                <br>ğŸ“ Mensaje: ${payload.notification?.body}
                <br>ğŸ“Š Datos: ${JSON.stringify(payload.data, null, 2)}
            `;
        });
    </script>
</body>
</html>
