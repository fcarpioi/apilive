/**
 * @openapi
 * info:
 *   title: Live API Gateway
 *   version: "2.0.0"
 *   description: API para Live Copernico 2.0 - MIGRADA A NUEVA ESTRUCTURA. Todas las APIs han sido migradas a la nueva estructura /races/{raceId}/events/{eventId}/.
 * servers:
 *   - url: https://us-central1-live-copernico.cloudfunctions.net/liveApiGateway
 *     description: Servidor de producci贸n Firebase
 *   - url: http://127.0.0.1:5001/live-copernico/us-central1/liveApiGateway
 *     description: Servidor de desarrollo local
 */

import express from "express";
import cors from "cors";
import { onRequest } from "firebase-functions/v2/https";
import { setGlobalOptions } from "firebase-functions/v2/options";
import fileUpload from "express-fileupload";
import admin from "firebase-admin";
import swaggerJSDoc from "swagger-jsdoc";
import swaggerUi from "swagger-ui-express";

// Importa routers
import uploadStory from "./routes/uploadStory.mjs";
import apiGeneral from "./routes/apiGeneral.mjs";
import upload from "./routes/upload.mjs";
import uploadMedia from "./routes/uploadMedia.mjs";
import uploadMediaSimple from "./routes/uploadMediaSimple.mjs";
import uploadMediaRaw from "./routes/uploadMediaRaw.mjs";
import uploadMediaBuffer from "./routes/uploadMediaBuffer.mjs";
import downloadAndUpload from "./routes/downloadAndUpload.mjs";
import altimetryRoutes from "./routes/altimetry.mjs";

// Inicializa Firebase Admin si a煤n no se ha inicializado
if (!admin.apps.length) {
  admin.initializeApp();
}

// Configura la aplicaci贸n Express
const app = express();
app.use(cors({ origin: true }));

// Middleware para parsear archivos, JSON y urlencoded
app.use(fileUpload());
app.use(express.json());
app.use(express.urlencoded({ extended: true }));

app.use(express.json({ limit: "50mb" }));
app.use(express.urlencoded({ extended: true, limit: "50mb" }));

// Configuraci贸n de Swagger-jsdoc
const swaggerOptions = {
  definition: {
    openapi: "3.0.0",
    info: {
      title: "Live API Gateway",
      version: "2.0.0",
      description: "API para Live Copernico 2.0 - MIGRADA A NUEVA ESTRUCTURA. Todas las APIs han sido migradas a la nueva estructura /races/{raceId}/events/{eventId}/. Solo incluye APIs activamente implementadas y migradas.",
      contact: {
        name: "Live Copernico Team",
        email: "support@copernico.com"
      }
    },
    servers: [
      {
        url: "https://us-central1-live-copernico.cloudfunctions.net/liveApiGateway",
        description: "Servidor de producci贸n Firebase",
      },
      {
        url: "http://127.0.0.1:5001/live-copernico/us-central1/liveApiGateway",
        description: "Servidor de desarrollo local",
      },
    ],
    components: {
      securitySchemes: {
        ApiKeyAuth: {
          type: "apiKey",
          in: "header",
          name: "X-API-Key",
          description: "API Key para autenticaci贸n de webhooks"
        }
      }
    }
  },
  // Se incluyen las rutas de tus archivos donde est谩n las anotaciones JSDoc
  apis: ["./routes/*.mjs", "./index.mjs"],
};

const swaggerSpec = swaggerJSDoc(swaggerOptions);

// Monta el endpoint de Swagger UI para la documentaci贸n interactiva
app.use("/docs", swaggerUi.serve, swaggerUi.setup(swaggerSpec));

//  Montar routers
app.use("/api", uploadStory);
app.use("/api", apiGeneral);
app.use("/api", upload);
app.use("/api", uploadMedia);
app.use("/api", uploadMediaSimple);
app.use("/api", uploadMediaRaw);
app.use("/api", uploadMediaBuffer);
app.use("/api", downloadAndUpload);
app.use("/api", altimetryRoutes);

//  Configurar Firebase Functions con m谩s memoria y tiempo de ejecuci贸n
setGlobalOptions({
  timeoutSeconds: 540,
  memory: "1GB",
});

//  Importar funci贸n independiente
import downloadUploadApp from "./downloadUpload.mjs";

//  Importar triggers de Firestore
import { onUserFollowsParticipant } from "./triggers/followingTrigger.mjs";

//  Importar funciones WebSocket (COMENTADO TEMPORALMENTE PARA DESPLIEGUE)
/*
import {
  websocketManager,
  keepWebSocketAlive,
  initWebSocketOnDeploy
} from "./websocket/websocketManager.mjs";

//  Importar funciones de monitoreo
import {
  websocketHealthCheck,
  cleanupOldMetrics
} from "./monitoring/websocketMonitor.mjs";
*/

//  Exportar las funciones
export const liveApiGateway = onRequest(app);
export const downloadUpload = onRequest(downloadUploadApp);

//  Exportar triggers de Firestore
export { onUserFollowsParticipant };

//  Exportar funciones WebSocket (COMENTADO TEMPORALMENTE PARA DESPLIEGUE)
/*
export {
  websocketManager,
  keepWebSocketAlive,
  initWebSocketOnDeploy
};

//  Exportar funciones de monitoreo
export {
  websocketHealthCheck,
  cleanupOldMetrics
};
*/